<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8">
  <link href="../style.css" rel="stylesheet">
  <link href="../favicon.ico" rel="icon" sizes="32x32">
  <title>
   ConTeXt and Lua programming/LPeg Lua Parsing Expression Grammars&mdash;ConTeXt Wiki Mirror
  </title>
  <link href="https://wiki.contextgarden.net/ConTeXt_and_Lua_programming/LPeg_Lua_Parsing_Expression_Grammars" rel="canonical">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <meta content="#241504" name="theme-color">
  <meta content="light dark" name="color-scheme">
 </head>
 <body>
  <header>
   <h1 id="page-title">
    ConTeXt and Lua programming/LPeg Lua Parsing Expression Grammars
   </h1>
   <p>Unofficial <a href="https://wiki.contextgarden.net/">ConTeXt Wiki</a> mirror</p>
   <p>Last modified: <a href="https://wiki.contextgarden.net/index.php?curid=2601&diff=40543">2025-01-14</a>
        </p>
  </header>
  <article>
   <div class="mw-parser-output">
    <div class="toc" id="toc">
     <input class="toctogglecheckbox" id="toctogglecheckbox" role="button" style="display:none" type="checkbox">
     <div class="toctitle" dir="ltr" lang="en">
      <h2>
       Contents
      </h2>
      <span class="toctogglespan">
       <label class="toctogglelabel" for="toctogglecheckbox">
       </label>
      </span>
     </div>
     <ul>
      <li class="toclevel-1 tocsection-1">
       <a href="#Writing_a_parser_with_LPeg">
        <span class="tocnumber">
         1
        </span>
        <span class="toctext">
         Writing a parser with LPeg
        </span>
       </a>
       <ul>
        <li class="toclevel-2 tocsection-2">
         <a href="#First_version_for_a_sgf_parser">
          <span class="tocnumber">
           1.1
          </span>
          <span class="toctext">
           First version for a sgf parser
          </span>
         </a>
        </li>
        <li class="toclevel-2 tocsection-3">
         <a href="#A_extended_version">
          <span class="tocnumber">
           1.2
          </span>
          <span class="toctext">
           A extended version
          </span>
         </a>
        </li>
       </ul>
      </li>
      <li class="toclevel-1 tocsection-4">
       <a href="#External_Links">
        <span class="tocnumber">
         2
        </span>
        <span class="toctext">
         External Links
        </span>
       </a>
      </li>
     </ul>
    </div>
    <h2>
     <span class="mw-headline" id="Writing_a_parser_with_LPeg">
      Writing a parser with LPeg
     </span>
    </h2>
    <p>To parser input files for the use with TeX you could either write Lua macros to convert pass the input to TeX or use LPeg to parse the files in a more simple manner.
</p>
    <h3>
     <span class="mw-headline" id="First_version_for_a_sgf_parser">
      First version for a sgf parser
     </span>
    </h3>
    <p>The code below reads input in sgf syntax and pass the content to TeX macros.
</p>
    <pre class="tex"><span class="cs"><span class="systemcs">\startluacode</span></span>

do

    thirddata     <span class="brx">=</span> thirddata     or <span class="br">{</span> <span class="br">}</span>
    thirddata.sgf <span class="brx">=</span> thirddata.sgf or <span class="br">{</span> <span class="br">}</span>

    local function command<span class="brx">(</span>name,x<span class="brx">)</span>
        tex.sprint<span class="brx">(</span>tex.texcatcodes,string.format<span class="brx">(</span>"<span class="cs">\\</span>csname sgf!<span class="comment">%s\\endcsname{%s}",name,x))</span>
    end

    local nodes <span class="brx">=</span> <span class="br">{</span> <span class="br">}</span>

    function nodes.B<span class="brx">(</span>x<span class="brx">)</span> command<span class="brx">(</span>"black",x<span class="brx">)</span> end
    function nodes.W<span class="brx">(</span>x<span class="brx">)</span> command<span class="brx">(</span>"white",x<span class="brx">)</span> end

    local function action<span class="brx">(</span>what,data<span class="brx">)</span>
        local a <span class="brx">=</span> nodes<span class="brx">[</span>what<span class="brx">]</span>
        if a then
            a<span class="brx">(</span>data<span class="brx">)</span>
        else
            print<span class="brx">(</span>"unknown action: " .. what<span class="brx">)</span>
        end
    end

    local function start<span class="brx">(</span><span class="brx">)</span>
        nesting <span class="brx">=</span> nesting + 1
        command<span class="brx">(</span>"start",nesting<span class="brx">)</span>
    end

    local function stop<span class="brx">(</span><span class="brx">)</span>
        command<span class="brx">(</span>"stop",nesting<span class="brx">)</span>
        nesting <span class="brx">=</span> nesting - 1
    end

    local space    <span class="brx">=</span> lpeg.S<span class="brx">(</span>' <span class="cs">\r</span><span class="cs">\n</span>'<span class="brx">)</span>^1
    local lower    <span class="brx">=</span> lpeg.R<span class="brx">(</span>"az"<span class="brx">)</span>
    local upper    <span class="brx">=</span> lpeg.R<span class="brx">(</span>"AZ"<span class="brx">)</span>
    local letter   <span class="brx">=</span> lower + upper
    local position <span class="brx">=</span> letter^2
    local left     <span class="brx">=</span> lpeg.P<span class="brx">(</span>"<span class="brx">(</span>"<span class="brx">)</span>
    local right    <span class="brx">=</span> lpeg.P<span class="brx">(</span>"<span class="brx">)</span>"<span class="brx">)</span>
    local none     <span class="brx">=</span> 1- <span class="brx">(</span>left + right<span class="brx">)</span>

    local node     <span class="brx">=</span> <span class="brx">(</span>lpeg.P<span class="brx">(</span>";"<span class="brx">)</span> * lpeg.C<span class="brx">(</span>lpeg.S<span class="brx">(</span>"BW"<span class="brx">)</span><span class="brx">)</span> * lpeg.P<span class="brx">(</span>"<span class="brx">[</span>"<span class="brx">)</span> * lpeg.C<span class="brx">(</span>position<span class="brx">)</span> * lpeg.P<span class="brx">(</span>"<span class="brx">]</span>"<span class="brx">)</span><span class="brx">)</span> / action
    local branch   <span class="brx">=</span> lpeg.P <span class="br">{</span> left/start * <span class="brx">(</span>lpeg.V<span class="brx">(</span>1<span class="brx">)</span> + node + space<span class="brx">)</span>^0 * right/stop <span class="br">}</span>

    local parser   <span class="brx">=</span> <span class="brx">(</span>branch + node + space<span class="brx">)</span>^0

    function thirddata.sgf.parsea<span class="brx">(</span>str<span class="brx">)</span>
        nesting <span class="brx">=</span> 0
        parser:match<span class="brx">(</span>str<span class="brx">)</span>
    end

    local function nest<span class="brx">(</span>str<span class="brx">)</span>
        tex.sprint<span class="brx">(</span>tex.ctxcatcodes,string.format<span class="brx">(</span>"<span class="cs">\\</span>parsesgfb<span class="br">{</span><span class="comment">%s}",str))</span>
    end

    local node     <span class="brx">=</span> <span class="brx">(</span>lpeg.P<span class="brx">(</span>";"<span class="brx">)</span> * lpeg.C<span class="brx">(</span>lpeg.S<span class="brx">(</span>"BW"<span class="brx">)</span><span class="brx">)</span> * lpeg.P<span class="brx">(</span>"<span class="brx">[</span>"<span class="brx">)</span> * lpeg.C<span class="brx">(</span>position<span class="brx">)</span> * lpeg.P<span class="brx">(</span>"<span class="brx">]</span>"<span class="brx">)</span><span class="brx">)</span> / action
    local branch   <span class="brx">=</span> lpeg.P <span class="br">{</span> left * <span class="brx">(</span>lpeg.V<span class="brx">(</span>1<span class="brx">)</span> + <span class="brx">(</span>none^1/nest<span class="brx">)</span> + space<span class="brx">)</span>^0 * right <span class="br">}</span>

    local parser   <span class="brx">=</span> <span class="brx">(</span>branch + node + space<span class="brx">)</span>^0

    function thirddata.sgf.parseb<span class="brx">(</span>str<span class="brx">)</span>
        nesting <span class="brx">=</span> 0
        parser:match<span class="brx">(</span>str<span class="brx">)</span>
    end

end

<span class="cs"><span class="systemcs">\stopluacode</span></span>
</pre>
    <p>To work with the output from the parser we need the following TeX macros.
</p>
    <pre class="tex"><span class="cs">\long</span><span class="cs">\def</span><span class="cs">\parsesgfa</span><span class="brx">#</span>1<span class="br">{</span><span class="cs"><span class="systemcs">\ctxlua</span></span><span class="br">{</span>thirddata.sgf.parsea<span class="brx">(</span>"<span class="brx">#</span>1"<span class="brx">)</span><span class="br">}</span><span class="br">}</span>
<span class="cs">\long</span><span class="cs">\def</span><span class="cs">\parsesgfb</span><span class="brx">#</span>1<span class="br">{</span><span class="cs"><span class="systemcs">\ctxlua</span></span><span class="br">{</span>thirddata.sgf.parseb<span class="brx">(</span>"<span class="brx">#</span>1"<span class="brx">)</span><span class="br">}</span><span class="br">}</span>

<span class="cs"><span class="systemcs">\starttexdefinition</span></span> sgf!start <span class="brx">#</span>1
    <span class="cs">\par</span> <span class="cs">\advance</span><span class="cs">\leftskip</span> by +2em
<span class="cs"><span class="systemcs">\stoptexdefinition</span></span>

<span class="cs"><span class="systemcs">\starttexdefinition</span></span> sgf!stop <span class="brx">#</span>1
    <span class="cs">\par</span> <span class="cs">\advance</span><span class="cs">\leftskip</span> by -2em
<span class="cs"><span class="systemcs">\stoptexdefinition</span></span>

<span class="cs"><span class="systemcs">\starttexdefinition</span></span> sgf!node <span class="brx">#</span>1
    Node: <span class="brx">#</span>1<span class="cs">\par</span>
<span class="cs"><span class="systemcs">\stoptexdefinition</span></span>

<span class="cs"><span class="systemcs">\starttexdefinition</span></span> sgf!white <span class="brx">#</span>1
    White: <span class="brx">#</span>1<span class="cs">\par</span>
<span class="cs"><span class="systemcs">\stoptexdefinition</span></span>

<span class="cs"><span class="systemcs">\starttexdefinition</span></span> sgf!black <span class="brx">#</span>1
    Black: <span class="brx">#</span>1<span class="cs">\par</span>
<span class="cs"><span class="systemcs">\stoptexdefinition</span></span>

<span class="cs">\protect</span>

<span class="cs"><span class="documentcs">\starttext</span></span>

<span class="cs">\parsesgfa</span><span class="br">{</span><span class="brx">(</span>;B<span class="brx">[</span>aa<span class="brx">]</span>;W<span class="brx">[</span>bb<span class="brx">]</span><span class="brx">(</span>;B<span class="brx">[</span>cc<span class="brx">]</span><span class="brx">(</span>;B<span class="brx">[</span>dd<span class="brx">]</span>;W<span class="brx">[</span>ee<span class="brx">]</span><span class="brx">(</span>;B<span class="brx">[</span>ff<span class="brx">]</span><span class="brx">)</span>;W<span class="brx">[</span>gg<span class="brx">]</span><span class="brx">)</span><span class="brx">)</span>;W<span class="brx">[</span>hh<span class="brx">]</span><span class="brx">)</span><span class="br">}</span>
<span class="cs"><span class="documentcs">\blank</span></span>
<span class="cs">\parsesgfb</span><span class="br">{</span><span class="brx">(</span>;B<span class="brx">[</span>aa<span class="brx">]</span>;W<span class="brx">[</span>bb<span class="brx">]</span><span class="brx">(</span>;B<span class="brx">[</span>cc<span class="brx">]</span><span class="brx">(</span>;B<span class="brx">[</span>dd<span class="brx">]</span>;W<span class="brx">[</span>ee<span class="brx">]</span><span class="brx">(</span>;B<span class="brx">[</span>ff<span class="brx">]</span><span class="brx">)</span>;W<span class="brx">[</span>gg<span class="brx">]</span><span class="brx">)</span><span class="brx">)</span>;W<span class="brx">[</span>hh<span class="brx">]</span><span class="brx">)</span><span class="br">}</span>

<span class="cs"><span class="documentcs">\stoptext</span></span>
</pre>
    <h3>
     <span class="mw-headline" id="A_extended_version">
      A extended version
     </span>
    </h3>
    <p>The second version of the sgf parser is less restricted to the arguments for the commands in the input and delimits the arguments in a slightly different way than the first version.
</p>
    <pre class="tex"><span class="cs"><span class="systemcs">\startluacode</span></span>

do

    thirddata     <span class="brx">=</span> thirddata     or <span class="br">{</span> <span class="br">}</span>
    thirddata.sgf <span class="brx">=</span> thirddata.sgf or <span class="br">{</span> <span class="br">}</span>

    local function command<span class="brx">(</span>name,x<span class="brx">)</span>
        tex.sprint<span class="brx">(</span>tex.texcatcodes,string.format<span class="brx">(</span>"<span class="cs">\\</span>csname sgf!<span class="comment">%s\\endcsname{%s}",name,x))</span>
    end

    local nodes <span class="brx">=</span> <span class="br">{</span> <span class="br">}</span>

    function nodes.B <span class="brx">(</span>x<span class="brx">)</span> command<span class="brx">(</span>"black"   ,x<span class="brx">)</span> end
    function nodes.W <span class="brx">(</span>x<span class="brx">)</span> command<span class="brx">(</span>"white"   ,x<span class="brx">)</span> end
    function nodes.AW<span class="brx">(</span>x<span class="brx">)</span> command<span class="brx">(</span>"addwhite",x<span class="brx">)</span> end
    function nodes.C <span class="brx">(</span>x<span class="brx">)</span> command<span class="brx">(</span>"comment" ,x<span class="brx">)</span> end

    local function action<span class="brx">(</span>what,data<span class="brx">)</span>
        local a <span class="brx">=</span> nodes<span class="brx">[</span>what<span class="brx">]</span>
        if a then
            for w in string.gmatch<span class="brx">(</span>data,"<span class="comment">%b[]") do</span>
                a<span class="brx">(</span>string.sub<span class="brx">(</span>w,2,-2<span class="brx">)</span><span class="brx">)</span>
            end
        else
            print<span class="brx">(</span>"unknown action: " .. what<span class="brx">)</span>
        end
    end

    local function nodecontent<span class="brx">(</span>str<span class="brx">)</span>
        tex.sprint<span class="brx">(</span>tex.ctxcatcodes,string.format<span class="brx">(</span>"<span class="cs">\\</span>csname sgf!node<span class="cs">\\</span>endcsname<span class="br">{</span><span class="comment">%s}",string.sub(str,2)))</span>
    end

    local space      <span class="brx">=</span> lpeg.S<span class="brx">(</span>' <span class="cs">\r</span><span class="cs">\n</span>'<span class="brx">)</span>^1
    local lcletter   <span class="brx">=</span> lpeg.R<span class="brx">(</span>"az"<span class="brx">)</span>
    local ucletter   <span class="brx">=</span> lpeg.R<span class="brx">(</span>"AZ"<span class="brx">)</span>
    local letter     <span class="brx">=</span> lcletter + ucletter

    local propindent <span class="brx">=</span> ucletter^1

    local property   <span class="brx">=</span> lpeg.C<span class="brx">(</span>propindent<span class="brx">)</span> * lpeg.C<span class="br">{</span> <span class="brx">(</span>lpeg.P<span class="brx">(</span>"<span class="brx">[</span>"<span class="brx">)</span> * <span class="brx">(</span>1 - lpeg.S"<span class="brx">[</span><span class="brx">]</span>"<span class="brx">)</span>^0 * lpeg.P<span class="brx">(</span>"<span class="brx">]</span>"<span class="brx">)</span><span class="brx">)</span>^1<span class="br">}</span> / action
	
    local function nest<span class="brx">(</span>str<span class="brx">)</span>
        tex.sprint<span class="brx">(</span>tex.ctxcatcodes,string.format<span class="brx">(</span>"<span class="cs">\\</span>parsesgf<span class="br">{</span><span class="comment">%s}",string.sub(str,2,-2)))</span>
    end

    local node   <span class="brx">=</span> lpeg.P<span class="br">{</span> ";" * <span class="brx">(</span>propindent * <span class="brx">(</span>lpeg.P<span class="brx">(</span>"<span class="brx">[</span>"<span class="brx">)</span> * <span class="brx">(</span>1 - lpeg.S"<span class="brx">[</span><span class="brx">]</span>"<span class="brx">)</span>^0 * lpeg.P<span class="brx">(</span>"<span class="brx">]</span>"<span class="brx">)</span><span class="brx">)</span>^1<span class="brx">)</span>^1<span class="br">}</span> / nodecontent
    local branch <span class="brx">=</span> lpeg.P<span class="br">{</span> "<span class="brx">(</span>" * <span class="brx">(</span><span class="brx">(</span>1 - lpeg.S"<span class="brx">(</span><span class="brx">)</span>"<span class="brx">)</span> + lpeg.V<span class="brx">(</span>1<span class="brx">)</span><span class="brx">)</span>^0 * "<span class="brx">)</span>" <span class="br">}</span>                             / nest

    local parser <span class="brx">=</span> <span class="brx">(</span>branch + node + property + space<span class="brx">)</span>^0

    function thirddata.sgf.parse<span class="brx">(</span>str<span class="brx">)</span>
        parser:match<span class="brx">(</span>str<span class="brx">)</span>
    end

end

<span class="cs"><span class="systemcs">\stopluacode</span></span>
</pre>
    <p>The TeX code for the second version is nearly the same as in the first draft, this was the goal for both version because it is more important to keep the interface in TeX and make the modifications in low level TeX or Lua code.
</p>
    <pre class="tex"><span class="cs">\def</span><span class="cs">\sgfflush</span><span class="brx">#</span>1<span class="br">{</span><span class="cs"><span class="systemcs">\ctxlua</span></span><span class="br">{</span>thirddata.sgf.parse<span class="brx">(</span>"<span class="brx">#</span>1"<span class="brx">)</span><span class="br">}</span><span class="br">}</span>

<span class="cs"><span class="systemcs">\starttexdefinition</span></span> parsesgf <span class="brx">#</span>1
    <span class="cs">\par</span> <span class="cs">\advance</span><span class="cs">\leftskip</span> by +2em
    <span class="cs">\sgfflush</span><span class="br">{</span><span class="brx">#</span>1<span class="br">}</span>
    <span class="cs">\par</span> <span class="cs">\advance</span><span class="cs">\leftskip</span> by -2em
<span class="cs"><span class="systemcs">\stoptexdefinition</span></span>

<span class="cs"><span class="systemcs">\starttexdefinition</span></span> sgf!node <span class="brx">#</span>1
    <span class="cs">\par</span> <span class="cs">\sgfflush</span><span class="br">{</span><span class="brx">#</span>1<span class="br">}</span>
<span class="cs"><span class="systemcs">\stoptexdefinition</span></span>

<span class="cs"><span class="systemcs">\starttexdefinition</span></span> sgf!white <span class="brx">#</span>1
    White: <span class="brx">#</span>1<span class="cs"><span class="stylecs">\quad</span></span>
<span class="cs"><span class="systemcs">\stoptexdefinition</span></span>

<span class="cs"><span class="systemcs">\starttexdefinition</span></span> sgf!black <span class="brx">#</span>1
    Black: <span class="brx">#</span>1<span class="cs"><span class="stylecs">\quad</span></span>
<span class="cs"><span class="systemcs">\stoptexdefinition</span></span>

<span class="cs"><span class="systemcs">\starttexdefinition</span></span> sgf!addwhite <span class="brx">#</span>1
    Add White: <span class="brx">#</span>1<span class="cs"><span class="stylecs">\quad</span></span>
<span class="cs"><span class="systemcs">\stoptexdefinition</span></span>

<span class="cs"><span class="systemcs">\starttexdefinition</span></span> sgf!comment <span class="brx">#</span>1
    Comment: <span class="brx">#</span>1<span class="cs"><span class="stylecs">\quad</span></span>
<span class="cs"><span class="systemcs">\stoptexdefinition</span></span>

<span class="cs">\protect</span>

<span class="cs"><span class="documentcs">\starttext</span></span>

<span class="cs">\parsesgf</span><span class="br">{</span><span class="brx">(</span>;C<span class="brx">[</span>First move in game 123<span class="brx">]</span>B<span class="brx">[</span>aa<span class="brx">]</span>AW<span class="brx">[</span>aa<span class="brx">]</span>;W<span class="brx">[</span>bb<span class="brx">]</span><span class="brx">(</span>;B<span class="brx">[</span>cc<span class="brx">]</span><span class="brx">(</span>;B<span class="brx">[</span>dd<span class="brx">]</span>;W<span class="brx">[</span>ee<span class="brx">]</span><span class="brx">[</span>ff<span class="brx">]</span><span class="brx">(</span>;B<span class="brx">[</span>ff<span class="brx">]</span><span class="brx">)</span>;W<span class="brx">[</span>gg<span class="brx">]</span><span class="brx">)</span><span class="brx">)</span>;W<span class="brx">[</span>hh<span class="brx">]</span><span class="brx">)</span><span class="br">}</span>

<span class="cs"><span class="documentcs">\stoptext</span></span>
</pre>
    <h2>
     <span class="mw-headline" id="External_Links">
      External Links
     </span>
    </h2>
    <ul>
     <li>
      <a class="external free" href="http://www.inf.puc-rio.br/~roberto/lpeg.html" rel="nofollow">
       http://www.inf.puc-rio.br/~roberto/lpeg.html
      </a>
     </li>
     <li>
      <a class="external free" href="http://www.red-bean.com/sgf/" rel="nofollow">
       http://www.red-bean.com/sgf/
      </a>
     </li>
     <li>
      <a class="external free" href="http://www.gammon.com.au/lpeg" rel="nofollow">
       http://www.gammon.com.au/lpeg
      </a>
     </li>
     <li>
      <a class="external free" href="https://en.wikipedia.org/wiki/Parsing_expression_grammar" rel="nofollow">
       https://en.wikipedia.org/wiki/Parsing_expression_grammar
      </a>
     </li>
    </ul>
   </div>
  </article>
  <footer>
   <ul role="list">
    <li>
     <a href="../index.html">
      Home
     </a>
    </li>
    <li>
     Mirrored on 2026-01-12
    </li>
    <li>
     <a href="http://www.gnu.org/copyleft/fdl.html" rel="license">
      GFDL 1.2
     </a>
    </li>
    <li>
     <a href="https://wiki.contextgarden.net/ConTeXt_and_Lua_programming/LPeg_Lua_Parsing_Expression_Grammars">
      Original page
     </a>
    </li>
   </ul>
  </footer>
 </body>
</html>
