<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8">
  <link href="../style.css" rel="stylesheet">
  <link href="../favicon.ico" rel="icon" sizes="32x32">
  <title>
   Input and compilation/Unexpected behavior&mdash;ConTeXt Wiki Mirror
  </title>
  <link href="https://wiki.contextgarden.net/Input_and_compilation/Unexpected_behavior" rel="canonical">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <meta content="#241504" name="theme-color">
  <meta content="light dark" name="color-scheme">
 </head>
 <body>
  <header>
   <h1 id="page-title">
    Input and compilation/Unexpected behavior
   </h1>
   <p>Unofficial <a href="https://wiki.contextgarden.net/">ConTeXt Wiki</a> mirror</p>
   <p>Last modified: <a href="https://wiki.contextgarden.net/index.php?curid=4572&diff=40428">2025-01-18</a>
        </p>
  </header>
  <article>
   <div class="mw-parser-output">
    <p>If ConTeXt appears to behave in a counterintuitive way, chances are
that it&rsquo;s actually your intuitions that lack calibration.
</p>
    <div class="toc" id="toc">
     <input class="toctogglecheckbox" id="toctogglecheckbox" role="button" style="display:none" type="checkbox">
     <div class="toctitle" dir="ltr" lang="en">
      <h3>
       Contents
      </h3>
      <span class="toctogglespan">
       <label class="toctogglelabel" for="toctogglecheckbox">
       </label>
      </span>
     </div>
     <ul>
      <li class="toclevel-1 tocsection-1">
       <a href="#Controlling_Page_Break_Before_Headings">
        <span class="tocnumber">
         1
        </span>
        <span class="toctext">
         Controlling Page Break Before Headings
        </span>
       </a>
      </li>
      <li class="toclevel-1 tocsection-2">
       <a href="#Unsolicited_Vertical_Mode">
        <span class="tocnumber">
         2
        </span>
        <span class="toctext">
         Unsolicited Vertical Mode
        </span>
       </a>
      </li>
      <li class="toclevel-1 tocsection-3">
       <a href="#Disappearing_Crop_Marks">
        <span class="tocnumber">
         3
        </span>
        <span class="toctext">
         Disappearing Crop Marks
        </span>
       </a>
      </li>
      <li class="toclevel-1 tocsection-4">
       <a href="#Left_and_Right">
        <span class="tocnumber">
         4
        </span>
        <span class="toctext">
         Left and Right
        </span>
       </a>
      </li>
      <li class="toclevel-1 tocsection-5">
       <a href="#Footnotes:_The_Difference_between_.5Csetupnotation_and_.5Csetupnote">
        <span class="tocnumber">
         5
        </span>
        <span class="toctext">
         Footnotes: The Difference between \setupnotation and \setupnote
        </span>
       </a>
      </li>
      <li class="toclevel-1 tocsection-6">
       <a href="#Float_Insertion_Issues">
        <span class="tocnumber">
         6
        </span>
        <span class="toctext">
         Float Insertion Issues
        </span>
       </a>
       <ul>
        <li class="toclevel-2 tocsection-7">
         <a href="#The_.E2.80.9Cparagraph_in_a_group.E2.80.9D_problem">
          <span class="tocnumber">
           6.1
          </span>
          <span class="toctext">
           The &ldquo;paragraph in a group&rdquo; problem
          </span>
         </a>
        </li>
       </ul>
      </li>
      <li class="toclevel-1 tocsection-8">
       <a href="#Syntax">
        <span class="tocnumber">
         7
        </span>
        <span class="toctext">
         Syntax
        </span>
       </a>
       <ul>
        <li class="toclevel-2 tocsection-9">
         <a href="#Assignments">
          <span class="tocnumber">
           7.1
          </span>
          <span class="toctext">
           Assignments
          </span>
         </a>
        </li>
        <li class="toclevel-2 tocsection-10">
         <a href="#Treacherous_Dimensions">
          <span class="tocnumber">
           7.2
          </span>
          <span class="toctext">
           Treacherous Dimensions
          </span>
         </a>
        </li>
       </ul>
      </li>
      <li class="toclevel-1 tocsection-11">
       <a href="#Multipass">
        <span class="tocnumber">
         8
        </span>
        <span class="toctext">
         Multipass
        </span>
       </a>
       <ul>
        <li class="toclevel-2 tocsection-12">
         <a href="#Trialtypesetting">
          <span class="tocnumber">
           8.1
          </span>
          <span class="toctext">
           Trialtypesetting
          </span>
         </a>
        </li>
        <li class="toclevel-2 tocsection-13">
         <a href="#Tables">
          <span class="tocnumber">
           8.2
          </span>
          <span class="toctext">
           Tables
          </span>
         </a>
        </li>
        <li class="toclevel-2 tocsection-14">
         <a href="#Metapost">
          <span class="tocnumber">
           8.3
          </span>
          <span class="toctext">
           Metapost
          </span>
         </a>
        </li>
       </ul>
      </li>
     </ul>
    </div>
    <h3>
     <span class="mw-headline" id="Controlling_Page_Break_Before_Headings">
      Controlling Page Break Before Headings
     </span>
    </h3>
    <p>If you add the option <code>page=yes</code> to a heading setup, this
will cause ConTeXt to break the page.
Ordinarily this works as expected, unless, however, the heading
immediately follows a previous section heading with no text in between.
The rationale behind this is that consecutive headings are conceived of
collectively as one single structural element.
For example, the following code will generate only a single page
break although the unit <tt><a class="mw-redirect" href="../Command/_section.html" title="Command/section">\section</a></tt> appears twice.
</p>
    <pre class="tex"><span class="cs"><span class="stylecs">\setuphead</span></span><span class="brx">[</span>section<span class="brx">]</span><span class="brx">[</span>page<span class="brx">=</span>yes<span class="brx">]</span> <span class="comment">%% toggle page breaking</span>

<span class="cs"><span class="documentcs">\starttext</span></span>
  <span class="cs"><span class="documentcs">\chapter</span></span><span class="br">{</span>foo<span class="br">}</span> <span class="comment">%% structural inhibits breaking</span>
  <span class="cs"><span class="documentcs">\section</span></span><span class="br">{</span>bar<span class="br">}</span> <span class="cs"><span class="documentcs">\input</span></span> knuth    <span class="comment">%% -&gt; no break!</span>
  <span class="cs"><span class="documentcs">\section</span></span><span class="br">{</span>baz<span class="br">}</span> <span class="cs"><span class="documentcs">\input</span></span> dawkins  <span class="comment">%% -&gt; break</span>
<span class="cs"><span class="documentcs">\stoptext</span></span>
</pre>
    <p>In order to get the page break at the section regardless of surrounding
structurals elements, you need to <i>unset</i> the heading parameter
<code>continue</code> as well.
<a class="external autonumber" href="http://archive.contextgarden.net/message/20080107.115201.ca26c682.en.html" rel="nofollow">[1]</a>
</p>
    <pre class="tex"><span class="cs"><span class="stylecs">\setuphead</span></span><span class="brx">[</span>section<span class="brx">]</span><span class="brx">[</span>page<span class="brx">=</span>yes,continue<span class="brx">=</span>no<span class="brx">]</span>

<span class="cs"><span class="documentcs">\starttext</span></span>
  <span class="cs"><span class="documentcs">\chapter</span></span><span class="br">{</span>foo<span class="br">}</span>
  <span class="cs"><span class="documentcs">\section</span></span><span class="br">{</span>bar<span class="br">}</span> <span class="cs"><span class="documentcs">\input</span></span> knuth    <span class="comment">%% -&gt; break</span>
  <span class="cs"><span class="documentcs">\section</span></span><span class="br">{</span>baz<span class="br">}</span> <span class="cs"><span class="documentcs">\input</span></span> dawkins  <span class="comment">%% -&gt; break</span>
<span class="cs"><span class="documentcs">\stoptext</span></span>
</pre>
    <p>(For the curious, the explanation can be found in the definition of the
macro <tt>\strc_sectioning_handle_page_nop</tt> in <a class="external text" href="https://source.contextgarden.net/tex/context/base/mkiv/strc-sec.mkiv" rel="nofollow">strc-sec.mkiv</a>).
</p>
    <h3>
     <span class="mw-headline" id="Unsolicited_Vertical_Mode">
      Unsolicited Vertical Mode
     </span>
    </h3>
    <p>Some commands like <tt><a href="../Command/framed.html" title="Command/framed">\framed</a></tt> cause line breaks to happen if used
in vertical mode, e.g. at the beginning of a line.
Example:
</p>
    <ul class="demosbs">
     <li class="code">
      <pre class="tex"><span class="cs"><span class="documentcs">\framed</span></span><span class="br">{</span>foo<span class="br">}</span> bar.
</pre>
     </li>
     <li class="rendering">
      <img height="48" src="../wikiteximage/e6ecc20f26590a1ff5b099e6923a6039.webp" width="32">
     </li>
    </ul>
    <p>The explanation according to the corresponding
<a class="external text" href="http://wiki.contextgarden.net/FAQ#Why_is_there_a_line-break_in_the_output_after_some_commands.3F" rel="nofollow">FAQ item</a>
is that before the token <code>\frame</code> is encountered, TEX is
in vertical mode.
This state is <i>preserved until after TEX finishes typesetting the</i>
<code>\framed</code> macro<i>.</i>
Consequently, horizontal mode (where paragraphs are made) is entered
only at the tokens <code>bar</code>.
</p>
    <p>To have the frame begin the paragraph instead, horizontal mode will
have to be initiated explicitly.
There are a couple macros for this purpose: the very basic
<tt><a class="new" href="../index.php?title=Command/leavevmode&action=edit&redlink=1.html" title="Command/leavevmode (page does not exist)">\leavevmode</a></tt> (<a class="external text" href="https://source.contextgarden.net/tex/context/base/mkiv/syst-ini.mkiv" rel="nofollow">syst-ini.mkiv</a>; inserts an empty box, same
as in the Plain format) and the more familiar <tt><a class="new" href="../index.php?title=Command/dontleavehmode&action=edit&redlink=1.html" title="Command/dontleavehmode (page does not exist)">\dontleavehmode</a></tt>
(<a class="external text" href="https://source.contextgarden.net/tex/context/base/mkiv/syst-aux.mkiv" rel="nofollow">syst-aux.mkiv</a>).
Just use the chosen macro immediately before the <code>\framed</code> macro and
everything should be fine:
</p>
    <ul class="demosbs">
     <li class="code">
      <pre class="tex"><span class="cs">\leavevmode</span>     <span class="cs"><span class="documentcs">\framed</span></span><span class="br">{</span>foo<span class="br">}</span> bar.<span class="cs">\par</span>
<span class="cs"><span class="stylecs">\dontleavehmode</span></span> <span class="cs"><span class="documentcs">\framed</span></span><span class="br">{</span>foo<span class="br">}</span> bar.
</pre>
     </li>
     <li class="rendering">
      <img height="56" src="../wikiteximage/f24cd695c725331583a94a1b422b5543.webp" width="64">
     </li>
    </ul>
    <h3>
     <span class="mw-headline" id="Disappearing_Crop_Marks">
      Disappearing Crop Marks
     </span>
    </h3>
    <p>Crop marks, activated as <code>\setuplayout[marking=on]</code>, are a
useful feature that Context supports out of the box.
They have a peculiarity, though, which my make them useless in specific
cases: They are, by definition, located <i>outside the page dimension</i>.
This means that they show up iff the paper size exceeds the page size.
</p>
    <p>Thus if you need auxiliary lines for cutting but have the pages fit the
paper size exactly, you can instead resort to enabling the <b>page</b>
background frame<b>.</b>
This example sums up the solutions posted by Wolfgang and Marco on
[<a class="external free" href="http://archive.contextgarden.net/message/20120605.202113.0989aa34.en.html" rel="nofollow">http://archive.contextgarden.net/message/20120605.202113.0989aa34.en.html</a>
the Context Mailing List].
</p>
    <pre class="tex"><span class="comment">%% the paper size will be a multiple of the page sizes</span>
<span class="cs"><span class="stylecs">\setuppapersize</span></span> <span class="brx">[</span>A6,landscape<span class="brx">]</span> <span class="brx">[</span>A3<span class="brx">]</span> 
<span class="cs"><span class="stylecs">\setuplayout</span></span>    <span class="brx">[</span>nx<span class="brx">=</span>2,ny<span class="brx">=</span>4<span class="brx">]</span><span class="comment">%, marking=on] </span>
<span class="comment">%% enable the page frame</span>
<span class="cs"><span class="stylecs">\setupbackgrounds</span></span>   <span class="brx">[</span>page<span class="brx">]</span> <span class="brx">[</span>frame<span class="brx">=</span>on<span class="brx">]</span>
<span class="comment">%% some further display setups</span>
<span class="cs"><span class="stylecs">\setuppagenumbering</span></span> <span class="brx">[</span>location<span class="brx">=</span><span class="brx">]</span> 
<span class="cs"><span class="stylecs">\setupbackgrounds</span></span>   <span class="brx">[</span>page<span class="brx">]</span>      <span class="brx">[</span>background<span class="brx">=</span>color, backgroundcolor<span class="brx">=</span>gray<span class="brx">]</span> 
<span class="cs"><span class="stylecs">\setupbodyfont</span></span>      <span class="brx">[</span>sans,58pt<span class="brx">]</span> 
<span class="comment">%% testing ...</span>
<span class="cs"><span class="documentcs">\starttext</span></span> 
<span class="cs"><span class="systemcs">\dorecurse</span></span><span class="br">{</span>4<span class="br">}</span> 
 <span class="br">{</span><span class="cs">\null</span><span class="cs">\vfill</span><span class="cs"><span class="documentcs">\centerline</span></span><span class="cs"><span class="systemcs">\recurselevel</span></span><span class="cs">\vfill</span><span class="cs">\null</span><span class="cs"><span class="documentcs">\page</span></span><span class="br">}</span> 
<span class="cs"><span class="documentcs">\stoptext</span></span>
</pre>
    <h3>
     <span class="mw-headline" id="Left_and_Right">
      Left and Right
     </span>
    </h3>
    <p>When it comes to the justification of paragraphs, do not trust your
intuitions about <i>handedness</i>.
This is a <a href="../Text_blocks/Typography/Alignment.html" title="Text blocks/Typography/Alignment">FAQ item</a>.
</p>
    <h3>
     <span id="Footnotes:_The_Difference_between_\setupnotation_and_\setupnote">
     </span>
     <span class="mw-headline" id="Footnotes:_The_Difference_between_.5Csetupnotation_and_.5Csetupnote">
      Footnotes: The Difference between
      <tt>
       <a href="../Command/setupnotation.html" title="Command/setupnotation">
        \setupnotation
       </a>
      </tt>
      and
      <tt>
       <a href="../Command/setupnote.html" title="Command/setupnote">
        \setupnote
       </a>
      </tt>
     </span>
    </h3>
    <p>There is a bit of terminology mess concerning notes.
</p>
    <table cellpadding="10" style="border:2px solid #addeff">
     <tbody>
      <tr>
       <th style="background:#addeff;">
        Instruction
       </th>
       <th>
        Goal
       </th>
      </tr>
      <tr>
       <td><tt><a href="../Command/setupnotation.html" title="Command/setupnotation">\setupnotation</a></tt>
</td>
       <td>This command configures the <b>note insert</b>, i.e. the textual content that will usually be placed at the bottom (with footnotes) or the end of the text (with endnotes).  (The control sequence used to be <code>\setupnotedefinition</code>.)
</td>
      </tr>
      <tr>
       <td><tt><a href="../Command/setupnote.html" title="Command/setupnote">\setupnote</a></tt>
</td>
       <td>Configure the <b>note environment</b> where the inserts will be located. Inherits some parameters from <tt><a href="../Command/framed.html" title="Command/framed">\framed</a></tt>.
</td>
      </tr>
      <tr>
       <td><code>\setupnote[textstyle=,textcommand=]</code>
</td>
       <td>Configure the <b>note symbol</b> as appears in the main text, where the note macro is called.
</td>
      </tr>
      <tr>
       <td>Plural forms <tt><a href="../Command/setupnotes.html" title="Command/setupnotes">\setupnotes</a></tt>, <tt><a class="new" href="../index.php?title=Command/setupnotations&action=edit&redlink=1.html" title="Command/setupnotations (page does not exist)">\setupnotations</a></tt>
</td>
       <td>These are synonyms for their singular forms.
</td>
      </tr>
      <tr>
       <td><tt><a href="../Command/setupfootnotes.html" title="Command/setupfootnotes">\setupfootnotes</a></tt>
</td>
       <td>This is equivalent to <code>\setupnote[footnote]</code>.
</td>
      </tr>
     </tbody>
    </table>
    <p><i>Summary</i>:
to setup a blue note, you would first need to define and configure the
insert via <tt><a href="../Command/setupnotation.html" title="Command/setupnotation">\setupnotation</a></tt>:
</p>
    <pre class="tex"><span class="cs"><span class="stylecs">\definenote</span></span> <span class="brx">[</span>bluenote<span class="brx">]</span> <span class="brx">[</span>footnote<span class="brx">]</span>
<span class="cs"><span class="stylecs">\setupnotation</span></span> <span class="brx">[</span>bluenote<span class="brx">]</span> <span class="brx">[</span>
  color<span class="brx">=</span>blue,
  style<span class="brx">=</span>bf,
<span class="brx">]</span>
 
<span class="cs"><span class="documentcs">\starttext</span></span> foo<span class="cs">\bluenote</span><span class="br">{</span>bar<span class="br">}</span> baz <span class="cs"><span class="documentcs">\stoptext</span></span>
</pre>
    <p>Now adjust the container where the blue notes will reside at the bottom
of the page (<tt><a href="../Command/setupnote.html" title="Command/setupnote">\setupnote</a></tt>):
</p>
    <pre class="tex"><span class="cs"><span class="stylecs">\definenote</span></span> <span class="brx">[</span>bluenote<span class="brx">]</span> <span class="brx">[</span>footnote<span class="brx">]</span>
<span class="cs"><span class="stylecs">\setupnote</span></span> <span class="brx">[</span>bluenote<span class="brx">]</span> <span class="brx">[</span>
  frame<span class="brx">=</span>on,          <span class="comment">%% frame containing all inserts</span>
  framecolor<span class="brx">=</span>blue,
  background<span class="brx">=</span>screen,
  rulecolor<span class="brx">=</span>blue,    <span class="comment">%% the line above the inserts</span>
  rulethickness<span class="brx">=</span>1pt, <span class="comment">%% both the frame and line width</span>
<span class="brx">]</span>

<span class="cs"><span class="documentcs">\starttext</span></span> foo<span class="cs">\bluenote</span><span class="br">{</span>bar<span class="br">}</span> baz <span class="cs">\bluenote</span><span class="br">{</span>xyzzy<span class="br">}</span> <span class="cs"><span class="documentcs">\stoptext</span></span>
</pre>
    <p>Finally, direct your attention to the note indicator, most commonly a
number or a symbol.
For precise control over the placement define a monadic macro and hook
it into <code>textcommand</code>.
</p>
    <pre class="tex"><span class="cs"><span class="stylecs">\setupnote</span></span> <span class="brx">[</span>bluenote<span class="brx">]</span> <span class="brx">[</span>
  textstyle<span class="brx">=</span><span class="cs"><span class="documentcs">\tx</span></span><span class="cs"><span class="documentcs">\sans</span></span><span class="cs"><span class="documentcs">\bold</span></span><span class="cs">\blue</span>,
  textcommand<span class="brx">=</span><span class="cs">\myfootnotecommand</span>,
<span class="brx">]</span>
<span class="cs"><span class="systemcs">\define</span></span><span class="brx">[</span>1<span class="brx">]</span><span class="cs">\myfootnotecommand</span><span class="br">{</span><span class="cs"><span class="documentcs">\rotate</span></span><span class="brx">[</span>rotation<span class="brx">=</span>42<span class="brx">]</span><span class="br">{</span><span class="brx">#</span>1<span class="br">}</span><span class="br">}</span>

<span class="cs"><span class="documentcs">\starttext</span></span> foo<span class="cs">\bluenote</span><span class="br">{</span>bar<span class="br">}</span> baz <span class="cs">\bluenote</span><span class="br">{</span>xyzzy<span class="br">}</span> <span class="cs"><span class="documentcs">\stoptext</span></span>
</pre>
    <p>(For more definite answers concerning the <i>notes</i> mechanism, use the
source, Luke: <a class="external text" href="https://source.contextgarden.net/tex/context/base/mkiv/strc-not.mkvi" rel="nofollow">strc-not.mkvi</a>.)
</p>
    <h3>
     <span class="mw-headline" id="Float_Insertion_Issues">
      Float Insertion Issues
     </span>
    </h3>
    <p>Floating objects can be tricky.
Deciding where they fit best is hard enough, actually getting them
there may be a lot tougher.
Inserting a float will force a line break where the object is
referenced in the source code.
Thus, very long paragraphs may not leave an opportunity to inject the
float if they cover the entire page.
<a class="external autonumber" href="http://archive.contextgarden.net/message/20120405.103626.a1349c1c.en.html" rel="nofollow">[2]</a>
</p>
    <pre class="tex"><span class="cs"><span class="documentcs">\starttext</span></span>
  Cows make
  <span class="cs"><span class="documentcs">\placefigure</span></span><span class="brx">[</span>top<span class="brx">]</span><span class="br">{</span>A genuine Dutch cow.<span class="br">}</span><span class="br">{</span><span class="cs"><span class="documentcs">\externalfigure</span></span><span class="brx">[</span>cow<span class="brx">]</span><span class="br">}</span>
  great pets.
<span class="cs"><span class="documentcs">\stoptext</span></span>
</pre>
    <p>In these cases the <i>postponing mechanism</i> offers a reliable way out
(<tt><a href="../Command/startpostponing.html" title="Command/startpostponing">\startpostponing</a></tt>).
It lets you specify an offset (in pages) by which the content of the
postponing environment will be delayed.
In order to place a floating object at the top of the <i>n</i>th page from
the location it is encountered, its argument has needs to be
<code>[+n]</code>.
(Absolute pages can be specified as simply <code>[n]</code>.)
E.&nbsp;g. to put the float on the following page:
</p>
    <pre class="tex"><span class="cs"><span class="documentcs">\starttext</span></span>
  <span class="cs"><span class="documentcs">\startpostponing</span></span><span class="brx">[</span>+1<span class="brx">]</span>
    <span class="cs"><span class="documentcs">\placefigure</span></span><span class="brx">[</span>top<span class="brx">]</span><span class="br">{</span>A genuine Dutch cow.<span class="br">}</span><span class="br">{</span><span class="cs"><span class="documentcs">\externalfigure</span></span><span class="brx">[</span>cow.pdf<span class="brx">]</span><span class="br">}</span>
  <span class="cs"><span class="documentcs">\stoppostponing</span></span>
  <span class="cs"><span class="documentcs">\input</span></span> knuth
  <span class="cs"><span class="documentcs">\page</span></span>
  Cows make great pets.
<span class="cs"><span class="documentcs">\stoptext</span></span>
</pre>
    <h4>
     <span id="The_&ldquo;paragraph_in_a_group&rdquo;_problem">
     </span>
     <span class="mw-headline" id="The_.E2.80.9Cparagraph_in_a_group.E2.80.9D_problem">
      The &ldquo;paragraph in a group&rdquo; problem
     </span>
    </h4>
    <p>Another common issue with sidefloats is starting a paragraph in a group.
</p>
    <ul class="demo">
     <li class="code">
      <pre class="tex"><span class="cs"><span class="documentcs">\placefigure</span></span><span class="brx">[</span>right,none<span class="brx">]</span><span class="br">{</span><span class="br">}</span><span class="br">{</span><span class="cs"><span class="documentcs">\externalfigure</span></span><span class="brx">[</span>cow<span class="brx">]</span><span class="brx">[</span>width<span class="brx">=</span>0.25<span class="cs">\textwidth</span><span class="brx">]</span><span class="br">}</span>
Lorem ipsum dolor sit amet, consectetur adipiscing elit.

<span class="br">{</span><span class="cs">\bf</span> Oeps<span class="br">}</span> <span class="cs"><span class="documentcs">\samplefile</span></span><span class="br">{</span>lorem<span class="br">}</span>
</pre>
     </li>
     <li class="rendering">
      <img height="240" src="../wikiteximage/cd5532bf4c6e389712c8388f2e72e0e6.webp" width="642">
     </li>
    </ul>
    <p>As you can see the paragraph starting with &ldquo;Oeps&rdquo; overflows into the picture.
That is a well-known problem and there are posts about it on the mailing
list every once in a while.  The sidefigure mechanism uses <code>\parshape</code> to
make the paragraph flow around the figure.  The <code>\parshape</code> primitive only
applies to a single paragraph, so ConTeXt communicates the current
<code>\parshape</code> settings to the next paragraph using <code>\everypar</code>.  However, when
a new paragraph starts in a group, i.e.
</p>
    <pre class="tex"><span class="br">{</span><span class="cs">\bf</span> Oeps<span class="br">}</span> ...
</pre>
    <p>TeX inserts the <code>\everypar</code> tokens inside that group because only the
first letter starts the paragraph.  That is to say is effectively looks
like this
</p>
    <pre class="tex"><span class="comment">% \everypar inserted inside the group</span>
<span class="comment">% ~~~v</span>
<span class="br">{</span><span class="cs">\bf</span> <span class="cs">\the</span><span class="cs">\everypar</span> Opes<span class="br">}</span> ...
<span class="comment">% ~~~~~~~~~~~~~~~~~~~~~^</span>
<span class="comment">% Setting of \everypar are discarded again when leaving the group and \parshape is lost.</span>
</pre>
    <p>You have to explicitly start a new paragraph before opening a group.
The easiest way to do this is
</p>
    <pre class="tex"><span class="cs"><span class="stylecs">\dontleavehmode</span></span><span class="br">{</span><span class="cs">\bf</span> Oeps<span class="br">}</span> ...
</pre>
    <p>Now the <code>\everypar</code> tokens are inserted directly after <tt><a class="new" href="../index.php?title=Command/dontleavehmode&action=edit&redlink=1.html" title="Command/dontleavehmode (page does not exist)">\dontleavehmode</a></tt>
outside the group and the problem goes away.
</p>
    <h2>
     <span class="mw-headline" id="Syntax">
      Syntax
     </span>
    </h2>
    <h3>
     <span class="mw-headline" id="Assignments">
      Assignments
     </span>
    </h3>
    <p>Spaces before commas or before the closing <code>]</code> are <i><b>not</b></i> ignored in ConTeXt.  That is a common pitfall and leads to errors that can be confusing for beginner, especially those coming from LaTeX, where this is the default behaviour.  Formatting your keys like this might look nice but leads to spurious spaces:
</p>
    <ul class="demosbs">
     <li class="code">
      <pre class="tex"><span class="cs"><span class="systemcs">\getparameters</span></span><span class="brx">[</span>test<span class="brx">]</span>
    <span class="brx">[</span> foo<span class="brx">=</span>bar
    , hello<span class="brx">=</span>world
    <span class="brx">]</span>
&ldquo;<span class="cs">\testfoo</span>&rdquo; &ldquo;<span class="cs">\testhello</span>&rdquo;
</pre>
     </li>
     <li class="rendering">
      <img height="14" src="../wikiteximage/da24ed9f7b5832778fbecb4efe7c9982.webp" width="121">
     </li>
    </ul>
    <p>Instead it is recommended to adhere to the style that is used in the ConTeXt source to avoid problems with trailing spaces:
</p>
    <ul class="demosbs">
     <li class="code">
      <pre class="tex"><span class="cs"><span class="systemcs">\getparameters</span></span><span class="brx">[</span>test<span class="brx">]</span>
    <span class="brx">[</span>foo<span class="brx">=</span>bar,
     hello<span class="brx">=</span>world<span class="brx">]</span>
&ldquo;<span class="cs">\testfoo</span>&rdquo; &ldquo;<span class="cs">\testhello</span>&rdquo;
</pre>
     </li>
     <li class="rendering">
      <img height="14" src="../wikiteximage/bb4d0e600d70043405503527b107b6cc.webp" width="110">
     </li>
    </ul>
    <p>In the most common form of key-value type arguments, ConTeXt will
accept trailing commas or even empty items. For example, the following
code shows this tolerance for the command <tt><a href="../Command/definehighlight.html" title="Command/definehighlight">\definehighlight</a></tt>.
</p>
    <pre class="tex"><span class="cs"><span class="stylecs">\definehighlight</span></span> <span class="brx">[</span>dontmiss<span class="brx">]</span> <span class="brx">[</span>
  color<span class="brx">=</span>red,
  ,,            <span class="comment">%% empty option: do nothing</span>
  style<span class="brx">=</span>bold,   <span class="comment">%% trailing delimiter</span>
<span class="brx">]</span>
</pre>
    <p>This is the syntax accepted e.g. by the majority of setups and
<a href="../ConTeXt_and_Lua_programming/Tutorials/Commands_with_KeyVal_arguments.html" title="ConTeXt and Lua programming/Tutorials/Commands with KeyVal arguments">Commands with KeyVal arguments|<code>\getparameters</code></a>.
(For the parser code cf. <a class="external text" href="https://source.contextgarden.net/tex/context/base/mkiv/syst-aux.mkiv" rel="nofollow">syst-aux.mkiv</a>.)
</p>
    <p>There are, however, exceptions to this rule. A known case where
options are processed in a less tolerant fashion is
<tt><a class="mw-redirect" href="../Command/_setuplabeltext.html" title="Command/setuplabeltext">\setuplabeltext</a></tt>.
<a class="external autonumber" href="http://www.ntg.nl/pipermail/ntg-context/2012/067585.html" rel="nofollow">[3]</a>
Thus the following snippet will not compile, forcing ConTeXt to fail
with a cryptic <code>Argument of  ...</code> error message.
</p>
    <pre class="tex"><span class="cs"><span class="stylecs">\setuplabeltext</span></span>
 <span class="brx">[</span>Nomen<span class="brx">=</span>nomen,
  Est<span class="brx">=</span>est,
  Omen<span class="brx">=</span>est,<span class="brx">]</span> <span class="comment">%% &lt;= fails!</span>
<span class="cs"><span class="stylecs">\setuplabeltext</span></span> <span class="brx">[</span>Nomen<span class="brx">=</span>nomen, Est<span class="brx">=</span>est, Omen<span class="brx">=</span>omen<span class="brx">]</span> <span class="comment">%% &lt;= works</span>
<span class="cs"><span class="documentcs">\starttext</span></span>
<span class="cs"><span class="stylecs">\labeltext</span></span><span class="br">{</span>Nomen<span class="br">}</span>
<span class="cs"><span class="stylecs">\labeltext</span></span><span class="br">{</span>Est<span class="br">}</span>
<span class="cs"><span class="stylecs">\labeltext</span></span><span class="br">{</span>Omen<span class="br">}</span>
<span class="cs"><span class="documentcs">\stoptext</span></span>
</pre>
    <p>(A similar exception concerning <tt><a href="../Command/definepalet.html" title="Command/definepalet">\definepalet</a></tt> has been migrated
to the standard argument model but may still show the earlier behavior
in not so recent installations.
<a class="external autonumber" href="http://www.ntg.nl/pipermail/ntg-context/2012/067673.html" rel="nofollow">[4]</a>)
</p>
    <h3>
     <span class="mw-headline" id="Treacherous_Dimensions">
      Treacherous Dimensions
     </span>
    </h3>
    <p>At some places dimension-lookalikes are expected but they do not behave
exactly as in TEX per se because they are evaluated differently.
A very common example is the command <tt><a href="../Command/setupbodyfont.html" title="Command/setupbodyfont">\setupbodyfont</a></tt> that is
possibly called, albeit implicitly, in every production document.
Its argument, the <i>font size</i>, although it may look like an ordinary
dimension expression, will not have the same result if it has zeros
prepended or decimal places are specified.
</p>
    <p>Suppose you want to set the main font to a very large size:
</p>
    <pre class="tex"><span class="cs"><span class="stylecs">\setupbodyfont</span></span><span class="brx">[</span>42pt<span class="brx">]</span>
<span class="cs"><span class="documentcs">\starttext</span></span> foobar <span class="cs"><span class="documentcs">\stoptext</span></span>
</pre>
    <p>this works out well as long as you do not mistake the expression
<i>42pt</i> to be a real dimension.
</p>
    <p>In TEX dimensions (which are really just integers) are treated the same
irrespective of leading or trailing zeros used in the variable
assignment.
Thus the following are all equivalent:
</p>
    <pre class="tex"><span class="cs">\newdimen</span><span class="cs">\fortytwo</span><span class="cs">\fortytwo</span><span class="brx">=</span>42pt
<span class="cs">\newdimen</span><span class="cs">\fortytoo</span><span class="cs">\fortytoo</span><span class="brx">=</span>042pt
<span class="cs">\newdimen</span><span class="cs">\fortytww</span><span class="cs">\fortytww</span><span class="brx">=</span>42.00pt

<span class="cs"><span class="documentcs">\starttext</span></span>
  <span class="cs">\the</span><span class="cs">\fortytwo</span>\ <span class="cs">\ifnum</span><span class="cs">\fortytwo</span><span class="brx">=</span><span class="cs">\fortytoo</span><span class="cs"><span class="documentcs">\m</span></span><span class="br">{</span><span class="cs">\top</span><span class="br">}</span><span class="cs">\else</span><span class="cs"><span class="documentcs">\m</span></span><span class="br">{</span><span class="cs">\bot</span><span class="br">}</span><span class="cs">\fi</span><span class="cs">\par</span>
  <span class="cs">\the</span><span class="cs">\fortytoo</span>\ <span class="cs">\ifnum</span><span class="cs">\fortytwo</span><span class="brx">=</span><span class="cs">\fortytww</span><span class="cs"><span class="documentcs">\m</span></span><span class="br">{</span><span class="cs">\top</span><span class="br">}</span><span class="cs">\else</span><span class="cs"><span class="documentcs">\m</span></span><span class="br">{</span><span class="cs">\bot</span><span class="br">}</span><span class="cs">\fi</span><span class="cs">\par</span>
  <span class="cs">\the</span><span class="cs">\fortytww</span>\ <span class="cs">\ifnum</span><span class="cs">\fortytoo</span><span class="brx">=</span><span class="cs">\fortytww</span><span class="cs"><span class="documentcs">\m</span></span><span class="br">{</span><span class="cs">\top</span><span class="br">}</span><span class="cs">\else</span><span class="cs"><span class="documentcs">\m</span></span><span class="br">{</span><span class="cs">\bot</span><span class="br">}</span><span class="cs">\fi</span><span class="cs">\par</span>
<span class="cs"><span class="documentcs">\stoptext</span></span>
</pre>
    <p>However, this does not hold for the Context commands
<tt><a href="../Command/setupbodyfont.html" title="Command/setupbodyfont">\setupbodyfont</a></tt> and <tt><a href="../Command/switchtobodyfont.html" title="Command/switchtobodyfont">\switchtobodyfont</a></tt>.
With the latter macros, only the <i>pure-integer</i> specification
(<code>42pt</code>) can be used reliably, everything else, even though it
denotates the same TEX dimension, will result in a warning:
</p>
    <pre>fonts           &gt; bodyfont 42.0pt is defined (can better be done global)
</pre>
    <p>Additionally, if the code in question relies on font switching a lot
(e.g. Lua snippets that calculate font sizes from floating point
numbers), there will be a <i>huge</i> performance penalty because every time
a font switch occurs, the font will be reloaded entirely.
The reason for this is that the process of defining a font for the main
text is accompanied by a myriad of secondary definitions for different
relative font sizes (<tt>\tfx</tt>, <tt>\tfa</tt>
<a class="new" href="../index.php?title=Characters_words_and_fonts/Font_Switching&action=edit&redlink=1.html" title="Characters words and fonts/Font Switching (page does not exist)">and the likes</a>) and shapes &ndash; the
creation of the <i>body font environment</i>.
If the &ldquo;size&rdquo; requested by <tt><a href="../Command/setupbodyfont.html" title="Command/setupbodyfont">\setupbodyfont</a></tt> cannot be found in the
internal table, this environment will be rebuilt on the spot.
</p>
    <p><i>It is also not possible to catch these cases by predefining the corresponding bodyfont environments</i>
by placing <tt><a href="../Command/definebodyfontenvironment.html" title="Command/definebodyfontenvironment">\definebodyfontenvironment</a></tt> statements in the preamble.
So if you have, say:
</p>
    <pre class="tex"><span class="cs"><span class="stylecs">\definebodyfontenvironment</span></span><span class="brx">[</span>42.0pt<span class="brx">]</span>
<span class="cs"><span class="stylecs">\definebodyfontenvironment</span></span><span class="brx">[</span>042pt<span class="brx">]</span>
<span class="cs"><span class="stylecs">\definebodyfontenvironment</span></span><span class="brx">[</span>042.0pt<span class="brx">]</span>
<span class="cs"><span class="documentcs">\starttext</span></span>
  <span class="cs"><span class="stylecs">\setupbodyfont</span></span><span class="brx">[</span>42.0pt<span class="brx">]</span>  foo bar
  <span class="cs"><span class="stylecs">\setupbodyfont</span></span><span class="brx">[</span>042pt<span class="brx">]</span>   foo bar
  <span class="cs"><span class="stylecs">\setupbodyfont</span></span><span class="brx">[</span>042.0pt<span class="brx">]</span> foo bar
<span class="cs"><span class="documentcs">\stoptext</span></span>
</pre>
    <p>the warning and slowdown will occur regardless.
The only real option is to serve <tt><a href="../Command/setupbodyfont.html" title="Command/setupbodyfont">\setupbodyfont</a></tt> and the like
natural integers only.
</p>
    <p>Alternatively you can always employ raw font definitions, if there
isn&rsquo;t any need for the environment in the first place:
</p>
    <pre class="tex"><span class="cs"><span class="documentcs">\starttext</span></span>
  <span class="cs"><span class="stylecs">\definedfont</span></span><span class="brx">[</span>file:iwona-regular.otf at 42.0pt<span class="brx">]</span>  foo bar
  <span class="cs"><span class="stylecs">\definedfont</span></span><span class="brx">[</span>file:iwona-regular.otf at 042pt<span class="brx">]</span>   foo bar
  <span class="cs"><span class="stylecs">\definedfont</span></span><span class="brx">[</span>file:iwona-regular.otf at 042.0pt<span class="brx">]</span> foo bar
<span class="cs"><span class="documentcs">\stoptext</span></span>
</pre>
    <p>Here the dimensions are <i>real</i>.
</p>
    <p>For further information see
<a class="external text" href="http://www.ntg.nl/pipermail/ntg-context/2012/067324.html" rel="nofollow">this</a> and
<a class="external text" href="http://www.ntg.nl/pipermail/ntg-context/2012/066940.html" rel="nofollow">this</a>
thread on the mailing list.
</p>
    <h2>
     <span class="mw-headline" id="Multipass">
      Multipass
     </span>
    </h2>
    <p>In some circumstances, portions of code are evaluated two or more
times.
This can be disruptive in contexts where the order of actions is
important.
</p>
    <h3>
     <span class="mw-headline" id="Trialtypesetting">
      Trialtypesetting
     </span>
    </h3>
    <p>Often the size of elements must be calculated prior to determining the
optimal placements.
Probably the most common example are tables:
In order to align cells correctly the dimensions of later parts of the
document must already be determined before anything is typeset.
The stage during which this takes place is called *trial typesetting*.
</p>
    <p>The system mode <i>trialtypesetting</i> allows fine-grained control over
what code should be executed during what stage.
For instance, the naive definition of a macro that increments and
prints a counter register will behave erratically in tables:
</p>
    <ul class="demo">
     <li class="code">
      <pre class="tex"><span class="cs"><span class="stylecs">\setuppapersize</span></span><span class="brx">[</span>A6,landscape<span class="brx">]</span>

<span class="cs">\def</span> <span class="cs">\inccount</span> <span class="br">{</span><span class="comment">%</span>
  <span class="cs">\incrementnumber</span> <span class="brx">[</span>somecount<span class="brx">]</span><span class="comment">%</span>
  <span class="cs">\getnumber</span> <span class="brx">[</span>somecount<span class="brx">]</span><span class="comment">%</span>
<span class="br">}</span>
<span class="cs">\definenumber</span> <span class="brx">[</span>somecount<span class="brx">]</span>
<span class="cs">\setnumber</span>    <span class="brx">[</span>somecount<span class="brx">]</span> <span class="brx">[</span>42<span class="brx">]</span>

<span class="cs"><span class="documentcs">\starttext</span></span>

  before <span class="cs">\inccount</span>

  <span class="cs"><span class="documentcs">\startplacetable</span></span><span class="brx">[</span>location<span class="brx">=</span>here<span class="brx">]</span>
    <span class="cs"><span class="documentcs">\bTABLE</span></span>
      <span class="cs"><span class="documentcs">\bTR</span></span> <span class="cs"><span class="documentcs">\bTD</span></span> <span class="cs">\inccount</span> <span class="cs">\eTD</span> <span class="cs"><span class="documentcs">\bTD</span></span> <span class="cs">\inccount</span> <span class="cs">\eTD</span> <span class="cs">\eTR</span>
    <span class="cs">\eTABLE</span>
  <span class="cs"><span class="documentcs">\stopplacetable</span></span>

  after <span class="cs">\inccount</span>

<span class="cs"><span class="documentcs">\stoptext</span></span>
</pre>
     </li>
     <li class="rendering">
      <img height="620" src="../wikiteximage/810c21e33ae1662c7a0c84dd6f6da91a.webp" width="874">
     </li>
    </ul>
    <p>To bypass the extra evaluation, wrap the incrementation part in an
<code>\iftrialtypesetting</code> conditional.
</p>
    <ul class="demo">
     <li class="code">
      <pre class="tex"><span class="cs"><span class="stylecs">\setuppapersize</span></span><span class="brx">[</span>A6,landscape<span class="brx">]</span>
<span class="cs">\def</span> <span class="cs">\inccount</span> <span class="br">{</span><span class="comment">%</span>
  <span class="cs"><span class="systemcs">\iftrialtypesetting</span></span> <span class="cs">\else</span>
    <span class="cs">\incrementnumber</span> <span class="brx">[</span>somecount<span class="brx">]</span><span class="comment">%</span>
  <span class="cs">\fi</span>
  <span class="cs">\getnumber</span> <span class="brx">[</span>somecount<span class="brx">]</span><span class="comment">%</span>
<span class="br">}</span>

<span class="cs">\definenumber</span> <span class="brx">[</span>somecount<span class="brx">]</span>
<span class="cs">\setnumber</span>    <span class="brx">[</span>somecount<span class="brx">]</span> <span class="brx">[</span>42<span class="brx">]</span>

<span class="cs"><span class="documentcs">\starttext</span></span>

  before <span class="cs">\inccount</span>

  <span class="cs"><span class="documentcs">\startplacetable</span></span><span class="brx">[</span>location<span class="brx">=</span>here<span class="brx">]</span>
    <span class="cs"><span class="documentcs">\bTABLE</span></span>
      <span class="cs"><span class="documentcs">\bTR</span></span> <span class="cs"><span class="documentcs">\bTD</span></span> <span class="cs">\inccount</span> <span class="cs">\eTD</span> <span class="cs"><span class="documentcs">\bTD</span></span> <span class="cs">\inccount</span> <span class="cs">\eTD</span> <span class="cs">\eTR</span>
    <span class="cs">\eTABLE</span>
  <span class="cs"><span class="documentcs">\stopplacetable</span></span>

  after <span class="cs">\inccount</span>

<span class="cs"><span class="documentcs">\stoptext</span></span>
</pre>
     </li>
     <li class="rendering">
      <img height="620" src="../wikiteximage/63cc7b6f51611e1059bf430486a3c89c.webp" width="874">
     </li>
    </ul>
    <p><br>
Note that annoying as it may appear, the trial typesetting phase is
essential for certain features to work, so take extra care when
omitting it.
In the example above the number itself must be present as placeholder
during the first pass even though it has not been updated at this
point.
</p>
    <pre class="tex"><span class="cs">\def</span> <span class="cs">\inccount</span> <span class="br">{</span><span class="comment">%</span>
  <span class="cs"><span class="systemcs">\iftrialtypesetting</span></span> <span class="cs">\else</span>
    <span class="cs">\incrementnumber</span> <span class="brx">[</span>somecount<span class="brx">]</span><span class="comment">%</span>
    <span class="cs">\getnumber</span> <span class="brx">[</span>somecount<span class="brx">]</span><span class="comment">%         &lt;= wrong!</span>
  <span class="cs">\fi</span>
<span class="br">}</span>
</pre>
    <ul class="demo">
     <li class="rendering">
      <img height="620" src="../wikiteximage/8547129ba99459401488791c33f8cf9c.webp" width="874">
     </li>
    </ul>
    <h3>
     <span class="mw-headline" id="Tables">
      Tables
     </span>
    </h3>
    <p>In addition to trial typesetting Context also knows a <i>table</i> state:
</p>
    <ul class="demo">
     <li class="code">
      <pre class="tex"><span class="cs"><span class="stylecs">\setuppapersize</span></span><span class="brx">[</span>A6,landscape<span class="brx">]</span>
<span class="cs">\def</span> <span class="cs">\tablecheck</span> <span class="br">{</span><span class="cs">\ifintable</span> In table. <span class="cs">\else</span> Outside table. <span class="cs">\fi</span><span class="br">}</span>

<span class="cs"><span class="documentcs">\starttext</span></span>
  <span class="cs">\tablecheck</span>
  <span class="cs"><span class="documentcs">\startplacetable</span></span><span class="brx">[</span>location<span class="brx">=</span>here<span class="brx">]</span>
    <span class="cs"><span class="documentcs">\bTABLE</span></span>
      <span class="cs"><span class="documentcs">\bTR</span></span> <span class="cs"><span class="documentcs">\bTD</span></span> <span class="cs">\tablecheck</span> <span class="cs">\eTD</span> <span class="cs"><span class="documentcs">\bTD</span></span> <span class="cs">\tablecheck</span> <span class="cs">\eTD</span> <span class="cs">\eTR</span>
    <span class="cs">\eTABLE</span>
  <span class="cs"><span class="documentcs">\stopplacetable</span></span>
  <span class="cs">\tablecheck</span> <span class="comment">%% decrement</span>
<span class="cs"><span class="documentcs">\stoptext</span></span>
</pre>
     </li>
     <li class="rendering">
      <img height="620" src="../wikiteximage/0c2aa8796caa9759f7b8e7cbe719adc3.webp" width="874">
     </li>
    </ul>
    <h3>
     <span class="mw-headline" id="Metapost">
      Metapost
     </span>
    </h3>
    <p>As with TeX, Metapost sometimes requires multiple passes,
especially when processing text.
In the snippet below, the Metapost tracer reveals that the code is actually
evaluated twice:
</p>
    <pre class="tex"><span class="cs"><span class="stylecs">\enabletrackers</span></span><span class="brx">[</span>metapost.showlog<span class="brx">]</span>
<span class="cs"><span class="documentcs">\starttext</span></span>
  <span class="cs"><span class="documentcs">\startMPcode</span></span>
    show "This gets printed twice.";
    label <span class="brx">(</span>btex Some label text etex, <span class="brx">(</span>0,0<span class="brx">)</span><span class="brx">)</span>;
  <span class="cs"><span class="documentcs">\stopMPcode</span></span>
<span class="cs"><span class="documentcs">\stoptext</span></span>
</pre>
    <p>NB removing the <code>label</code> statement will result in the second
pass being omitted.
</p>
    <p>In <a href="../Graphics_and_media/Tutorials/Graphical_programming_with_MetaPost_and_MetaFun.html" title="Graphics and media/Tutorials/Graphical programming with MetaPost and MetaFun">Graphical programming with MetaPost and MetaFun</a>, the default Metapost format in Context, the booleans
<code>mfun_first_run</code> and <code>mfun_trial_run</code> allow
detecting the individual stages:
</p>
    <pre class="tex"><span class="cs"><span class="stylecs">\enabletrackers</span></span><span class="brx">[</span>metapost.showlog<span class="brx">]</span>
<span class="cs"><span class="documentcs">\starttext</span></span>
  <span class="cs"><span class="documentcs">\startMPcode</span></span>
    if mfun_trial_run&nbsp;:
      show "This gets printed during the trial pass.";
    else&nbsp;:
      show "This gets printed during the final pass.";
    fi;
    label <span class="brx">(</span>btex Some label text etex, <span class="brx">(</span>0,0<span class="brx">)</span><span class="brx">)</span>;
  <span class="cs"><span class="documentcs">\stopMPcode</span></span>
<span class="cs"><span class="documentcs">\stoptext</span></span>
</pre>
   </div>
  </article>
  <footer>
   <ul role="list">
    <li>
     <a href="../index.html">
      Home
     </a>
    </li>
    <li>
     Mirrored on 2026-01-11
    </li>
    <li>
     <a href="http://www.gnu.org/copyleft/fdl.html" rel="license">
      GFDL 1.2
     </a>
    </li>
    <li>
     <a href="https://wiki.contextgarden.net/Input_and_compilation/Unexpected_behavior">
      Original page
     </a>
    </li>
   </ul>
  </footer>
 </body>
</html>
